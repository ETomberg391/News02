{% extends "base.html" %}

{% block title %}RSS Feeds - News02{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-rss"></i> RSS Feed Management
                </h5>
                <button class="btn btn-primary btn-sm" onclick="addFeed()">
                    <i class="bi bi-plus-circle"></i> Add Feed
                </button>
            </div>
            <div class="card-body">
                <form id="feedsForm">
                    <div id="feedsList">
                        {% for feed_url in feed_urls %}
                        <div class="feed-item mb-3">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-rss"></i>
                                </span>
                                <input type="url" class="form-control" name="feeds[]" 
                                       value="{{ feed_url }}" placeholder="https://example.com/feed.xml">
                                <button type="button" class="btn btn-outline-danger" onclick="removeFeed(this)">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="testFeed(this)">
                                    <i class="bi bi-check-circle"></i>
                                </button>
                            </div>
                            {% if feed_url in feed_stats %}
                            <small class="text-muted">
                                {{ feed_stats[feed_url].article_count }} articles â€¢ 
                                Last: {{ feed_stats[feed_url].last_article or 'Never' }}
                            </small>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-circle"></i> Save Feeds
                            </button>
                            <button type="button" class="btn btn-outline-primary ms-2" onclick="importFeeds()">
                                <i class="bi bi-upload"></i> Import OPML
                            </button>
                            <button type="button" class="btn btn-outline-secondary ms-2" onclick="exportFeeds()">
                                <i class="bi bi-download"></i> Export OPML
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Popular Feeds Template -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-star"></i> Popular News Feeds
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>International News</h6>
                        <div class="list-group list-group-flush">
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>BBC World News</strong>
                                    <br><small class="text-muted">http://feeds.bbci.co.uk/news/world/rss.xml</small>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="addPopularFeed('http://feeds.bbci.co.uk/news/world/rss.xml')">Add</button>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Reuters World</strong>
                                    <br><small class="text-muted">https://feeds.reuters.com/reuters/worldNews</small>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="addPopularFeed('https://feeds.reuters.com/reuters/worldNews')">Add</button>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Guardian International</strong>
                                    <br><small class="text-muted">https://www.theguardian.com/international/rss</small>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="addPopularFeed('https://www.theguardian.com/international/rss')">Add</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Technology News</h6>
                        <div class="list-group list-group-flush">
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>TechCrunch</strong>
                                    <br><small class="text-muted">https://techcrunch.com/feed/</small>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="addPopularFeed('https://techcrunch.com/feed/')">Add</button>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Ars Technica</strong>
                                    <br><small class="text-muted">https://feeds.arstechnica.com/arstechnica/index</small>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="addPopularFeed('https://feeds.arstechnica.com/arstechnica/index')">Add</button>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Hacker News</strong>
                                    <br><small class="text-muted">https://feeds.feedburner.com/oreilly/radar</small>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="addPopularFeed('https://feeds.feedburner.com/oreilly/radar')">Add</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feed Statistics -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-bar-chart"></i> Feed Statistics
                </h5>
            </div>
            <div class="card-body">
                {% if feed_stats %}
                    <div class="list-group list-group-flush">
                        {% for feed_url, stats in feed_stats.items() %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ feed_url.split('/')[-1][:30] }}...</h6>
                                <span class="badge bg-primary">{{ stats.article_count }}</span>
                            </div>
                            <p class="mb-1">
                                <small>Last article: {{ stats.last_article or 'Never' }}</small>
                            </p>
                            <small class="text-muted">Active {{ stats.active_days }} days</small>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No feed statistics available. Enable database to track feed performance.</p>
                {% endif %}
            </div>
        </div>

        <!-- Feed Validation -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-shield-check"></i> Feed Validator
                </h5>
            </div>
            <div class="card-body">
                <div class="input-group mb-3">
                    <input type="url" class="form-control" id="validateFeedUrl" 
                           placeholder="https://example.com/feed.xml">
                    <button class="btn btn-outline-primary" onclick="validateSingleFeed()">
                        <i class="bi bi-check-circle"></i> Validate
                    </button>
                </div>
                <div id="validationResult"></div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-lightning"></i> Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <button class="btn btn-outline-success w-100 mb-2" onclick="testAllFeeds()">
                    <i class="bi bi-check-all"></i> Test All Feeds
                </button>
                <button class="btn btn-outline-warning w-100 mb-2" onclick="removeInvalidFeeds()">
                    <i class="bi bi-trash"></i> Remove Invalid
                </button>
                <button class="btn btn-outline-info w-100" onclick="sortFeeds()">
                    <i class="bi bi-sort-alpha-down"></i> Sort Alphabetically
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Import OPML Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import OPML File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="file" class="form-control" id="opmlFile" accept=".opml,.xml">
                <div class="form-text">Select an OPML file to import RSS feeds</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="processImport()">Import</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('feedsForm').addEventListener('submit', saveFeeds);
});

function addFeed() {
    const feedsList = document.getElementById('feedsList');
    const feedItem = document.createElement('div');
    feedItem.className = 'feed-item mb-3';
    feedItem.innerHTML = `
        <div class="input-group">
            <span class="input-group-text">
                <i class="bi bi-rss"></i>
            </span>
            <input type="url" class="form-control" name="feeds[]" 
                   value="" placeholder="https://example.com/feed.xml">
            <button type="button" class="btn btn-outline-danger" onclick="removeFeed(this)">
                <i class="bi bi-trash"></i>
            </button>
            <button type="button" class="btn btn-outline-info" onclick="testFeed(this)">
                <i class="bi bi-check-circle"></i>
            </button>
        </div>
    `;
    feedsList.appendChild(feedItem);
}

function removeFeed(button) {
    button.closest('.feed-item').remove();
}

function addPopularFeed(feedUrl) {
    // Check if feed already exists
    const existingInputs = document.querySelectorAll('input[name="feeds[]"]');
    for (let input of existingInputs) {
        if (input.value === feedUrl) {
            showAlert('Feed already exists in the list', 'warning');
            return;
        }
    }
    
    addFeed();
    const inputs = document.querySelectorAll('input[name="feeds[]"]');
    inputs[inputs.length - 1].value = feedUrl;
}

function testFeed(button) {
    const input = button.parentElement.querySelector('input');
    const feedUrl = input.value.trim();
    
    if (!feedUrl) {
        showAlert('Please enter a feed URL', 'warning');
        return;
    }
    
    const originalIcon = button.innerHTML;
    button.innerHTML = '<i class="bi bi-arrow-repeat spinning"></i>';
    button.disabled = true;
    
    // Simple validation - try to fetch the feed
    fetch('/api/test_feed', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({url: feedUrl})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            button.innerHTML = '<i class="bi bi-check-circle text-success"></i>';
            showAlert(`Feed is valid! Found ${data.articles || 0} articles.`, 'success');
        } else {
            button.innerHTML = '<i class="bi bi-exclamation-circle text-danger"></i>';
            showAlert('Feed validation failed: ' + (data.error || 'Unknown error'), 'danger');
        }
        
        setTimeout(() => {
            button.innerHTML = originalIcon;
            button.disabled = false;
        }, 2000);
    })
    .catch(error => {
        button.innerHTML = '<i class="bi bi-exclamation-circle text-danger"></i>';
        showAlert('Error testing feed: ' + error.message, 'danger');
        
        setTimeout(() => {
            button.innerHTML = originalIcon;
            button.disabled = false;
        }, 2000);
    });
}

function saveFeeds(event) {
    event.preventDefault();
    
    const inputs = document.querySelectorAll('input[name="feeds[]"]');
    const feeds = Array.from(inputs)
        .map(input => input.value.trim())
        .filter(url => url && url.startsWith('http'));
    
    if (feeds.length === 0) {
        showAlert('Please add at least one valid feed URL', 'warning');
        return;
    }
    
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="bi bi-arrow-repeat spinning"></i> Saving...';
    submitBtn.disabled = true;
    
    fetch('/api/save_feeds', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({feeds: feeds})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
        } else {
            showAlert('Error saving feeds: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error saving feeds: ' + error.message, 'danger');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function testAllFeeds() {
    const inputs = document.querySelectorAll('input[name="feeds[]"]');
    const buttons = document.querySelectorAll('.btn-outline-info');
    
    inputs.forEach((input, index) => {
        if (input.value.trim()) {
            setTimeout(() => {
                testFeed(buttons[index]);
            }, index * 1000); // Stagger requests
        }
    });
}

function removeInvalidFeeds() {
    if (confirm('This will remove feeds that appear to be invalid. Continue?')) {
        const feedItems = document.querySelectorAll('.feed-item');
        feedItems.forEach(item => {
            const input = item.querySelector('input[name="feeds[]"]');
            const url = input.value.trim();
            
            // Basic validation
            if (!url || !url.startsWith('http') || url.length < 10) {
                item.remove();
            }
        });
        showAlert('Invalid feeds removed', 'info');
    }
}

function sortFeeds() {
    const feedsList = document.getElementById('feedsList');
    const feedItems = Array.from(feedsList.querySelectorAll('.feed-item'));
    
    feedItems.sort((a, b) => {
        const urlA = a.querySelector('input').value.toLowerCase();
        const urlB = b.querySelector('input').value.toLowerCase();
        return urlA.localeCompare(urlB);
    });
    
    // Clear and re-add sorted items
    feedsList.innerHTML = '';
    feedItems.forEach(item => feedsList.appendChild(item));
    
    showAlert('Feeds sorted alphabetically', 'info');
}

function importFeeds() {
    const modal = new bootstrap.Modal(document.getElementById('importModal'));
    modal.show();
}

function processImport() {
    const fileInput = document.getElementById('opmlFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showAlert('Please select an OPML file', 'warning');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(e.target.result, 'text/xml');
            const outlines = xmlDoc.querySelectorAll('outline[xmlUrl]');
            
            outlines.forEach(outline => {
                const feedUrl = outline.getAttribute('xmlUrl');
                if (feedUrl) {
                    addPopularFeed(feedUrl);
                }
            });
            
            showAlert(`Imported ${outlines.length} feeds from OPML`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
            
        } catch (error) {
            showAlert('Error parsing OPML file: ' + error.message, 'danger');
        }
    };
    
    reader.readAsText(file);
}

function exportFeeds() {
    const inputs = document.querySelectorAll('input[name="feeds[]"]');
    const feeds = Array.from(inputs)
        .map(input => input.value.trim())
        .filter(url => url && url.startsWith('http'));
    
    if (feeds.length === 0) {
        showAlert('No feeds to export', 'warning');
        return;
    }
    
    // Generate OPML
    let opml = `<?xml version="1.0" encoding="UTF-8"?>
<opml version="1.0">
    <head>
        <title>News02 Feeds Export</title>
        <dateCreated>${new Date().toISOString()}</dateCreated>
    </head>
    <body>`;
    
    feeds.forEach(feed => {
        const title = feed.split('/').slice(-1)[0].replace('.xml', '').replace('.rss', '');
        opml += `\n        <outline text="${title}" xmlUrl="${feed}" />`;
    });
    
    opml += `
    </body>
</opml>`;
    
    // Download file
    const blob = new Blob([opml], {type: 'application/xml'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'news02_feeds.opml';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showAlert('Feeds exported successfully', 'success');
}

function validateSingleFeed() {
    const input = document.getElementById('validateFeedUrl');
    const feedUrl = input.value.trim();
    const resultDiv = document.getElementById('validationResult');
    
    if (!feedUrl) {
        showAlert('Please enter a feed URL', 'warning');
        return;
    }
    
    resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Validating...';
    
    // This would need to be implemented in the backend
    setTimeout(() => {
        resultDiv.innerHTML = `
            <div class="alert alert-success alert-sm">
                <strong>Valid Feed!</strong><br>
                Title: Example News Feed<br>
                Articles: 25<br>
                Last Updated: 2 hours ago
            </div>
        `;
    }, 1500);
}
</script>
{% endblock %}